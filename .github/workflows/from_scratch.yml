name: From Scratch

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - ".github/workflows/from_scratch.yml"

permissions:
  contents: read

concurrency:
  group: from-scratch-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  from_scratch:
    name: From Scratch - ${{ matrix.platform_name }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runs-on: macos-15-intel
            platform_name: "macOS x64"
            arch: "x64"
            python-version: "3.10"
          - runs-on: macos-latest
            platform_name: "macOS ARM64"
            arch: "arm64"
            python-version: "3.10"
          - runs-on: ubuntu-22.04
            platform_name: "Linux x64"
            arch: "x64"
            python-version: "3.10"
          - runs-on: ubuntu-22.04-arm
            platform_name: "Linux ARM64"
            arch: "arm64"
            python-version: "3.10"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # This step is not necessary for the build, but it is useful for debugging.
      - name: Install tools and dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install tree

      - name: Install tools and dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "================================================"
          echo "Installing Linux build dependencies"
          echo "================================================"

          sudo apt-get update

          # Install C++ build essentials and libc++ development packages
          # TEN Framework uses clang and statically links libc++ on Linux
          sudo apt-get install -y \
            clang \
            libc++-14-dev \
            libc++abi-dev \
            tree

          # On ARM64, create symlinks for libc++ static libraries
          # (x64 runners already have them in the standard location)
          if [ "${{ matrix.arch }}" == "arm64" ]; then
            if [ -f "/usr/lib/llvm-14/lib/libc++.a" ]; then
              echo ""
              echo "Creating symlinks for libc++ static libraries on ARM64..."
              sudo ln -sf /usr/lib/llvm-14/lib/libc++.a /usr/lib/aarch64-linux-gnu/libc++.a
              sudo ln -sf /usr/lib/llvm-14/lib/libc++abi.a /usr/lib/aarch64-linux-gnu/libc++abi.a
              echo "✓ Symlinks created successfully"
            fi
          fi

          echo ""
          echo "✓ Linux build dependencies installed successfully"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "stable"
          cache: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install tman using package manager
        run: |
          echo "================================================"
          echo "Installing tman on ${{ matrix.platform_name }} with Python ${{ matrix.python-version }}"
          echo "================================================"

          if [[ "${{ runner.os }}" == "macOS" ]]; then
            echo "Installing tman via Homebrew..."
            brew install TEN-framework/ten-framework/tman
          elif [[ "${{ runner.os }}" == "Linux" ]]; then
            echo "Installing tman via apt..."
            sudo add-apt-repository -y ppa:ten-framework/ten-framework
            sudo apt update
            sudo apt install -y tman
          else
            echo "❌ ERROR: Unsupported OS: ${{ runner.os }}"
            exit 1
          fi

          echo "✓ tman installation completed"

      - name: Verify tman installation
        run: |
          echo "================================================"
          echo "Verifying tman installation"
          echo "================================================"

          # Check if tman is installed
          if ! command -v tman &> /dev/null; then
            echo "❌ ERROR: tman is not installed"
            exit 1
          fi

          # Display tman version and location
          echo "✓ tman is installed successfully"
          echo "  Version: $(tman --version 2>&1 || tman -v 2>&1)"
          echo "  Location: $(which tman)"

          # Display Python version being used
          echo ""
          echo "Python configuration:"
          echo "  Version: $(python3 --version)"
          echo "  Location: $(which python3)"

          # Verify tman can run basic commands
          echo ""
          echo "Testing basic tman commands:"
          tman --help

      - name: Setup tgn (TEN build system)
        run: |
          echo "================================================"
          echo "Installing tgn build system for C++ extensions"
          echo "================================================"

          # Install tgn using the install script
          # The script automatically handles CI environment and skips interactive prompts
          bash tools/tgn/install_tgn.sh

          # Add tgn to PATH for subsequent steps
          echo "/usr/local/ten_gn" >> $GITHUB_PATH

          echo ""
          echo "✓ tgn setup completed"

      - name: Create transcriber_demo app using tman
        run: |
          echo "================================================"
          echo "Creating transcriber_demo app"
          echo "================================================"

          # Create a temporary directory for the app
          cd /tmp

          # Install the app using tman
          tman install app transcriber_demo

          # Verify the app was created
          if [ ! -d "transcriber_demo" ]; then
            echo "❌ ERROR: transcriber_demo app was not created"
            exit 1
          fi

          echo "✓ transcriber_demo app created successfully"

      - name: Verify app installation
        run: |
          echo "================================================"
          echo "Verifying transcriber_demo app structure"
          echo "================================================"

          cd /tmp/transcriber_demo

          # List the app structure
          echo "App directory structure:"
          ls -la

          # Check for common files/directories that should exist
          if [ -f "manifest.json" ]; then
            echo "✓ manifest.json exists"
          else
            echo "❌ WARNING: manifest.json not found"
          fi

          if [ -f "property.json" ]; then
            echo "✓ property.json exists"
          else
            echo "⚠ WARNING: property.json not found (may be optional)"
          fi

          echo ""
          echo "✓ App structure verification completed"

      - name: Install app dependencies with tman
        run: |
          echo "================================================"
          echo "Installing transcriber_demo ten packages"
          echo "================================================"

          cd /tmp/transcriber_demo

          # Install TEN package dependencies using tman
          tman install

          tree -I .

          if [ $? -eq 0 ]; then
            echo "✓ tman install completed successfully"
          else
            echo "❌ ERROR: tman install failed"
            exit 1
          fi

      - name: Install pip and npm dependencies
        run: |
          echo "================================================"
          echo "Installing pip and npm dependencies"
          echo "================================================"

          cd /tmp/transcriber_demo

          # Install Python and npm dependencies using tman
          tman run install_deps

          if [ $? -eq 0 ]; then
            echo "✓ Dependencies installed successfully"
          else
            echo "❌ ERROR: Failed to install dependencies"
            exit 1
          fi

      - name: Build app with tman
        run: |
          echo "================================================"
          echo "Building transcriber_demo app"
          echo "================================================"

          cd /tmp/transcriber_demo

          # Build the app using tman (includes go build and tsc compilation)
          tman run build

          if [ $? -ne 0 ]; then
            echo "❌ ERROR: tman run build failed"
            exit 1
          fi

          # Verify that bin/main was generated
          if [ -f "bin/main" ]; then
            echo "✓ bin/main generated successfully"
            ls -lh bin/main
          else
            echo "❌ ERROR: bin/main not found"
            echo "Contents of bin directory:"
            ls -la bin/ || echo "bin directory does not exist"
            exit 1
          fi

          echo ""
          echo "✓ Build verification completed"

      - name: Check nodejs_addon_loader manifest
        run: |
          echo "================================================"
          echo "Checking nodejs_addon_loader manifest.json"
          echo "================================================"

          cd /tmp/transcriber_demo

          if [ -f "ten_packages/addon_loader/nodejs_addon_loader/manifest.json" ]; then
            echo "✓ nodejs_addon_loader manifest.json exists"
            echo ""
            echo "Content of manifest.json:"
            cat ten_packages/addon_loader/nodejs_addon_loader/manifest.json
          else
            echo "❌ WARNING: nodejs_addon_loader manifest.json not found"
            echo "Listing ten_packages directory structure:"
            ls -la ten_packages/ || echo "ten_packages directory does not exist"
            if [ -d "ten_packages/addon_loader" ]; then
              echo "Contents of ten_packages/addon_loader:"
              ls -la ten_packages/addon_loader/
            fi
          fi

      - name: Run app with tman
        run: |
          echo "================================================"
          echo "Running transcriber_demo app on ${{ matrix.platform_name }} with Python ${{ matrix.python-version }}"
          echo "================================================"

          cd /tmp/transcriber_demo

          # Start the app in the background
          echo "Starting app with 'tman run start'..."
          tman run start &
          APP_PID=$!
          echo "App started with PID: $APP_PID"

          # Wait for the app to initialize (give it some time to start)
          echo "Waiting for app to initialize..."
          sleep 10

          # Check if the process is still running (not crashed)
          if ps -p $APP_PID > /dev/null; then
            echo "✓ App is running successfully (PID: $APP_PID)"
          else
            echo "❌ ERROR: App crashed or exited unexpectedly"
            exit 1
          fi

          # Let the app run for a bit to ensure stability
          echo "App is running, waiting for 5 more seconds..."
          sleep 5

          # Check again to ensure it's still running
          if ps -p $APP_PID > /dev/null; then
            echo "✓ App is still running stable"
          else
            echo "❌ ERROR: App crashed during runtime"
            exit 1
          fi

          # Gracefully stop the app by sending SIGTERM
          echo ""
          echo "Stopping app gracefully (sending SIGTERM to PID: $APP_PID)..."

          # Kill the process group to ensure all child processes are terminated
          kill -TERM -$APP_PID 2>/dev/null || kill -TERM $APP_PID || true

          # Wait for the app to shut down gracefully
          echo "Waiting for app to shut down..."
          sleep 3

          # Check if the app has stopped
          if ps -p $APP_PID > /dev/null 2>&1; then
            echo "⚠ App did not stop gracefully, sending SIGKILL..."
            kill -KILL -$APP_PID 2>/dev/null || kill -KILL $APP_PID || true
            sleep 1
          fi

          # Final check
          if ps -p $APP_PID > /dev/null 2>&1; then
            echo "❌ WARNING: App process still running"
          else
            echo "✓ App stopped successfully"
          fi

          # Extra cleanup: kill any remaining transcriber_demo processes
          echo "Cleaning up any remaining processes..."
          pkill -f "transcriber_demo" || true
          pkill -f "bin/main" || true

          echo ""
          echo "================================================"
          echo "✅ All verifications completed successfully on ${{ matrix.platform_name }} with Python ${{ matrix.python-version }}"
          echo "================================================"

      - name: Install C++ extension webrtc_vad_cpp
        run: |
          echo "================================================"
          echo "Installing C++ extension: webrtc_vad_cpp"
          echo "================================================"

          cd /tmp/transcriber_demo

          # Install the C++ extension from the cloud store
          tman install extension webrtc_vad_cpp

          if [ $? -eq 0 ]; then
            echo "✓ webrtc_vad_cpp extension installed successfully"
          else
            echo "❌ ERROR: Failed to install webrtc_vad_cpp extension"
            exit 1
          fi

      - name: Build app with C++ extension
        run: |
          echo "================================================"
          echo "Rebuilding app with C++ extension"
          echo "================================================"

          cd /tmp/transcriber_demo

          # Rebuild the app to compile the C++ extension into a dynamic library
          tman run build

          if [ $? -ne 0 ]; then
            echo "❌ ERROR: tman run build failed with C++ extension"
            exit 1
          fi

          echo "✓ App with C++ extension built successfully"

      - name: Run app with VAD functionality
        run: |
          echo "================================================"
          echo "Running transcriber_demo app with VAD functionality"
          echo "================================================"

          cd /tmp/transcriber_demo

          # Start the app with VAD support in the background
          echo "Starting app with 'tman run start_with_vad'..."
          tman run start_with_vad &
          APP_PID=$!
          echo "App started with PID: $APP_PID"

          # Wait for the app to initialize
          echo "Waiting for app to initialize..."
          sleep 10

          # Check if the process is still running (not crashed)
          if ps -p $APP_PID > /dev/null; then
            echo "✓ App with VAD is running successfully (PID: $APP_PID)"
          else
            echo "❌ ERROR: App with VAD crashed or exited unexpectedly"
            exit 1
          fi

          # Let the app run for a bit to ensure stability with C++ extension
          echo "App is running with VAD, waiting for 5 more seconds..."
          sleep 5

          # Check again to ensure it's still running
          if ps -p $APP_PID > /dev/null; then
            echo "✓ App with VAD is still running stable"
          else
            echo "❌ ERROR: App with VAD crashed during runtime"
            exit 1
          fi

          # Gracefully stop the app by sending SIGTERM
          echo ""
          echo "Stopping app gracefully (sending SIGTERM to PID: $APP_PID)..."

          # Kill the process group to ensure all child processes are terminated
          kill -TERM -$APP_PID 2>/dev/null || kill -TERM $APP_PID || true

          # Wait for the app to shut down gracefully
          echo "Waiting for app to shut down..."
          sleep 3

          # Check if the app has stopped
          if ps -p $APP_PID > /dev/null 2>&1; then
            echo "⚠ App did not stop gracefully, sending SIGKILL..."
            kill -KILL -$APP_PID 2>/dev/null || kill -KILL $APP_PID || true
            sleep 1
          fi

          # Final check
          if ps -p $APP_PID > /dev/null 2>&1; then
            echo "❌ WARNING: App process still running"
          else
            echo "✓ App with VAD stopped successfully"
          fi

          # Extra cleanup: kill any remaining transcriber_demo processes
          echo "Cleaning up any remaining processes..."
          pkill -f "transcriber_demo" || true
          pkill -f "bin/main" || true

          echo ""
          echo "================================================"
          echo "✅ C++ development environment verification completed on ${{ matrix.platform_name }} with Python ${{ matrix.python-version }}"
          echo "================================================"

      # ========================================
      # Extension Development Verification
      # ========================================

      - name: Create C++ extension
        run: |
          echo "================================================"
          echo "Creating C++ extension for testing"
          echo "================================================"

          cd /tmp

          # Create a C++ extension using the default template
          tman create extension test_ext_cpp --template default_extension_cpp

          if [ ! -d "test_ext_cpp" ]; then
            echo "❌ ERROR: test_ext_cpp extension was not created"
            exit 1
          fi

          echo "✓ C++ extension created successfully"

      - name: Install C++ extension dependencies
        run: |
          echo "================================================"
          echo "Installing C++ extension dependencies"
          echo "================================================"

          cd /tmp/test_ext_cpp

          # Install dependencies in standalone mode
          tman install --standalone

          if [ $? -eq 0 ]; then
            echo "✓ C++ extension dependencies installed successfully"
          else
            echo "❌ ERROR: Failed to install C++ extension dependencies"
            exit 1
          fi

      - name: Build C++ extension
        run: |
          echo "================================================"
          echo "Building C++ extension"
          echo "================================================"

          cd /tmp/test_ext_cpp

          # Determine OS and architecture for build
          if [[ "${{ runner.os }}" == "macOS" ]]; then
            if [[ "${{ matrix.arch }}" == "arm64" ]]; then
              OS_ARCH="mac arm64"
            else
              OS_ARCH="mac x64"
            fi
          else
            if [[ "${{ matrix.arch }}" == "arm64" ]]; then
              OS_ARCH="linux arm64"
            else
              OS_ARCH="linux x64"
            fi
          fi

          # Build using tman
          tman run build

          if [ $? -ne 0 ]; then
            echo "❌ ERROR: C++ extension build failed"
            exit 1
          fi

          # Verify that test binary was generated
          if [ -f "bin/test_ext_cpp_test" ]; then
            echo "✓ C++ extension test binary generated successfully"
            ls -lh bin/test_ext_cpp_test
          else
            echo "❌ ERROR: C++ extension test binary not found"
            echo "Contents of bin directory:"
            ls -la bin/ || echo "bin directory does not exist"
            exit 1
          fi

      - name: Test C++ extension
        run: |
          echo "================================================"
          echo "Testing C++ extension"
          echo "================================================"

          cd /tmp/test_ext_cpp

          # Run tests using tman
          tman run test

          if [ $? -eq 0 ]; then
            echo "✓ C++ extension tests passed successfully"
          else
            echo "❌ ERROR: C++ extension tests failed"
            exit 1
          fi

      - name: Create Go extension
        run: |
          echo "================================================"
          echo "Creating Go extension for testing"
          echo "================================================"

          cd /tmp

          # Create a Go extension using the default template
          tman create extension test_ext_go --template default_extension_go --template-data class_name_prefix=Test

          if [ ! -d "test_ext_go" ]; then
            echo "❌ ERROR: test_ext_go extension was not created"
            exit 1
          fi

          echo "✓ Go extension created successfully"

      - name: Install Go extension dependencies
        run: |
          echo "================================================"
          echo "Installing Go extension dependencies"
          echo "================================================"

          cd /tmp/test_ext_go

          # Install dependencies in standalone mode
          tman install --standalone

          if [ $? -eq 0 ]; then
            echo "✓ Go extension dependencies installed successfully"
          else
            echo "❌ ERROR: Failed to install Go extension dependencies"
            exit 1
          fi

      - name: Test Go extension
        run: |
          echo "================================================"
          echo "Testing Go extension"
          echo "================================================"

          cd /tmp/test_ext_go

          # Run tests using tman
          tman run test

          if [ $? -eq 0 ]; then
            echo "✓ Go extension tests passed successfully"
          else
            echo "❌ ERROR: Go extension tests failed"
            exit 1
          fi

      - name: Create Python extension
        run: |
          echo "================================================"
          echo "Creating Python extension for testing"
          echo "================================================"

          cd /tmp

          # Create a Python extension using the default async template
          tman create extension test_ext_python --template default_async_extension_python --template-data class_name_prefix=Test

          if [ ! -d "test_ext_python" ]; then
            echo "❌ ERROR: test_ext_python extension was not created"
            exit 1
          fi

          echo "✓ Python extension created successfully"

      - name: Install Python extension dependencies
        run: |
          echo "================================================"
          echo "Installing Python extension dependencies"
          echo "================================================"

          cd /tmp/test_ext_python

          # Install TEN framework dependencies in standalone mode
          tman install --standalone

          if [ $? -ne 0 ]; then
            echo "❌ ERROR: Failed to install TEN framework dependencies"
            exit 1
          fi

          # Install Python pip dependencies (pytest, etc.)
          if [ -f "requirements.txt" ]; then
            echo ""
            echo "Installing Python pip dependencies from requirements.txt..."
            python3 -m pip install -r requirements.txt

            if [ $? -eq 0 ]; then
              echo "✓ Python pip dependencies installed successfully"
            else
              echo "❌ ERROR: Failed to install Python pip dependencies"
              exit 1
            fi
          else
            echo "⚠ WARNING: requirements.txt not found, skipping pip install"
          fi

          echo "✓ All Python extension dependencies installed successfully"

      - name: Test Python extension
        run: |
          echo "================================================"
          echo "Testing Python extension"
          echo "================================================"

          cd /tmp/test_ext_python

          # Run tests using tman
          tman run test

          if [ $? -eq 0 ]; then
            echo "✓ Python extension tests passed successfully"
          else
            echo "❌ ERROR: Python extension tests failed"
            exit 1
          fi

      - name: Create Node.js extension
        run: |
          echo "================================================"
          echo "Creating Node.js extension for testing"
          echo "================================================"

          cd /tmp

          # Create a Node.js extension using the default template
          tman create extension test_ext_nodejs --template default_extension_nodejs --template-data class_name_prefix=Test

          if [ ! -d "test_ext_nodejs" ]; then
            echo "❌ ERROR: test_ext_nodejs extension was not created"
            exit 1
          fi

          echo "✓ Node.js extension created successfully"

      - name: Install Node.js extension dependencies
        run: |
          echo "================================================"
          echo "Installing Node.js extension dependencies"
          echo "================================================"

          cd /tmp/test_ext_nodejs

          # Install dependencies in standalone mode
          tman install --standalone

          if [ $? -eq 0 ]; then
            echo "✓ Node.js extension dependencies installed successfully"
          else
            echo "❌ ERROR: Failed to install Node.js extension dependencies"
            exit 1
          fi

      - name: Build Node.js extension
        run: |
          echo "================================================"
          echo "Building Node.js extension"
          echo "================================================"

          cd /tmp/test_ext_nodejs

          # Build using tman (compiles TypeScript)
          tman run build

          if [ $? -ne 0 ]; then
            echo "❌ ERROR: Node.js extension build failed"
            exit 1
          fi

          # Verify that build output exists
          if [ -f ".ten/app/ten_packages/extension/test_ext_nodejs/build/index.js" ]; then
            echo "✓ Node.js extension compiled successfully"
            ls -lh .ten/app/ten_packages/extension/test_ext_nodejs/build/index.js
          else
            echo "⚠ WARNING: Build output not found in expected location"
            echo "Checking build directory:"
            find .ten -name "index.js" -type f || echo "No index.js found"
          fi

      - name: Test Node.js extension
        run: |
          echo "================================================"
          echo "Testing Node.js extension"
          echo "================================================"

          cd /tmp/test_ext_nodejs

          # Run tests using tman
          tman run test

          if [ $? -eq 0 ]; then
            echo "✓ Node.js extension tests passed successfully"
          else
            echo "❌ ERROR: Node.js extension tests failed"
            exit 1
          fi

      - name: Extension Development Summary
        if: always()
        run: |
          echo "================================================"
          echo "Extension Development Verification Summary"
          echo "================================================"
          echo "Platform: ${{ matrix.platform_name }}"
          echo "Python Version: ${{ matrix.python-version }}"
          echo ""
          echo "✅ All extension development workflows verified:"
          echo "  - C++ extension: Create → Install → Build → Test"
          echo "  - Go extension: Create → Install → Test"
          echo "  - Python extension: Create → Install → Test"
          echo "  - Node.js extension: Create → Install → Build → Test"
          echo ""
          echo "================================================"
